name: RAVA actions

on:
  workflow_call:
    secrets:
      lava_token:
        required: true

jobs:
  parse-request:
    runs-on: 'ubuntu-latest'
    outputs:
      lava_template: ${{ steps.parse.outputs.lava_template }}
      lava_testcase_url: ${{ steps.parse.outputs.lava_testcase_url }}
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      event_name: ${{ github.event_name }}
    steps:
      - id: parse
        run: |
          if [ "$event_name" = 'pull_request' ]; then
            title="$(gh pr view ${{ github.event.pull_request.number }} --json title -q '.title')"
            lava_template=$(echo "$title" | awk -F'-' '{print $1}')
            lava_template="${lava_template#[}"
            lava_template="${lava_template%]}"
            [ -z "$lava_template" ] && exit 1
            
            lava_testcase_url=$(echo "$title" | awk -F'-' '{print $2}')
            lava_testcase_url="${lava_testcase_url#[}"
            lava_testcase_url="${lava_testcase_url%]}"
            [ -z "$lava_testcase_url" ] && exit 1
            echo "lava_template=$lava_template" >> $GITHUB_OUTPUT
            echo "lava_testcase_url=$lava_testcase_url" >> $GITHUB_OUTPUT
          else
            
          fi

  trait-pr-change-file:
    if: ${{ github.event_name == 'pull_request' }}
    outputs:
      files: ${{ steps.get-files.outputs.files }}
    runs-on: 'ubuntu-latest'
    steps:
      - id: get-files
        run: |
          files=$(gh pr diff ${{ github.event.pull_request.number }} --name-only)
          echo "files=$files" >> $GITHUB_OUTPUT

  show-files:
    runs-on: 'ubuntu-latest'
    needs: [trait-push-change-file, trait-pr-change-file]
    if: ${{ always() }}
    env:
      files: ${{ needs.trait-push-change-file.outputs.files }}, ${{ needs.trait-pr-change-file.outputs.files }}
    steps:
      - run: |
         echo $files
      