name: RAVA actions

on:
  workflow_call:
    secrets:
      lava_token:
        required: true

jobs:
  parse-request:
    runs-on: 'ubuntu-latest'
    outputs:
      lava_template: ${{ steps.parse.outputs.lava_template }}
      lava_testcase_url: ${{ steps.parse.outputs.lava_testcase_url }}
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GH_REPO: ${{ github.repository }}
      event_name: ${{ github.event_name }}
    steps:
      - id: parse
        run: |
          if [ "$event_name" = 'pull_request' ] || [ "$event_name" = 'pull_request_target' ]; then
            title="$(gh pr view ${{ github.event.pull_request.number }} --json title -q '.title')"
            # title=[lava-job-template/qemu/qemu.yaml]-[lava-testcases/common-test/ltp/ltp.yaml]: xxx
            lava_template=$(echo "$title" | awk -F'\\]-\\[' '{print $1}')
            lava_template="${lava_template#\[}"
            lava_template="${lava_template%\]}"
            [ -z "$lava_template" ] && exit 0

            lava_testcase_url=$(echo "$title" | awk -F'-' '{print $2}')
            lava_testcase_url="${lava_testcase_url#\[}"
            lava_testcase_url="${lava_testcase_url%\]}"
            [ -z "$lava_testcase_url" ] && exit 0

          elif [ "$event_name" = 'issues' ]; then
            true
          elif [ "$event_name" = 'issue_comment' ]; then
            comment_body="${{ github.event.comment.body }}"
            if [ "$(echo "$comment_body" | awk -F'-' '{print $1}')" != '/check' ]; then
              echo "This is not a check command, exiting."
              exit 0
            fi
            lava_template=$(echo "$comment_body" | awk -F'lava_template=' '{print $2}' | awk '{print $1}')
            lava_testcase_url=$(echo "$comment_body" | awk -F'testcase_url=' '{print $2}' | awk '{print $1}')
          
          fi
          
          echo "lava_template=$lava_template" >> $GITHUB_OUTPUT
          echo "lava_testcase_url=$lava_testcase_url" >> $GITHUB_OUTPUT

          cat > $GITHUB_STEP_SUMMARY << EOF
          ## LAVA Check Request

          - **LAVA Template**: $lava_template
          - **Testcase URL**: $lava_testcase_url
          EOF

  
  run-lava-check:
    needs: [parse-request]
    if: ${{ needs.parse-request.outputs.lava_template && needs.parse-request.outputs.lava_testcase_url }}
    uses: ./.github/workflows/lava-trigger.yml
    secrets:
      lava_token: ${{ secrets.lava_token }}
    with:
      WORKFLOW_REPO: OERV-RVCI/RVCK-pipeline
      WORKFLOW_REF: actions
      REPO: ${{ github.repositoryUrl }}
      ISSUE_ID: ${{ github.event.issue.number || github.event.pull_request.number }}
      kernel_download_url: ''
      testcase_repo: ${{ github.repository.clone_url }}
      testcase_ref: ${{ github.ref }}
      lava_template: ${{ needs.parse-request.outputs.lava_template }}
      testcase_url: ${{ needs.parse-request.outputs.lava_testcase_url }}
      